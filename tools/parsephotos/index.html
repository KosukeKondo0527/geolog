<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Scrapbox向け写真ツール</title>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    .entry { margin-bottom: 1.5em; border-bottom: 1px solid #ccc; padding-bottom: 1em; }
    textarea { width: 100%; height: 150px; margin-top: 0.5em; font-family: monospace; }
    button.copy-button { margin-top: 0.5em; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Scrapbox向け 写真情報整形ツール（逆ジオ対応）</h1>
  <p>写真を選んでください（複数可）:</p>
  <input type="file" id="photoInput" multiple accept="image/*">
  <br>
  <button onclick="processPhotos()">処理開始</button>
  <div id="results"></div>

  <script>
    const clientId = "963b4c40415323f"; // ImgurのClient IDをここに入れる
    const openCageApiKey = "YOUR_OPENCAGE_API_KEY"; // OpenCage APIキーをここに入れる
    const scrapboxProject = "gyoku-log"; // Scrapboxのプロジェクト名

    function getExifData(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            EXIF.getData(img, function() {
              const date = EXIF.getTag(this, 'DateTimeOriginal') || '不明';
              const lat = EXIF.getTag(this, 'GPSLatitude');
              const lon = EXIF.getTag(this, 'GPSLongitude');
              const latRef = EXIF.getTag(this, 'GPSLatitudeRef') || 'N';
              const lonRef = EXIF.getTag(this, 'GPSLongitudeRef') || 'E';

              function convertDMSToDD(dms, ref) {
                const [d, m, s] = dms;
                let dd = d + (m / 60) + (s / 3600);
                return (ref === 'S' || ref === 'W') ? -dd : dd;
              }

              const latitude = lat ? convertDMSToDD(lat, latRef) : null;
              const longitude = lon ? convertDMSToDD(lon, lonRef) : null;

              resolve({ date, latitude, longitude });
            });
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function uploadToImgur(file) {
      const formData = new FormData();
      formData.append("image", file);
      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: {
          Authorization: `Client-ID ${clientId}`
        },
        body: formData
      });
      const data = await res.json();
      return data.data.link;
    }

    async function getCountryFromCoords(lat, lon) {
      return "Turkey"
      if (!lat || !lon) return "Unknown";
      const res = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${openCageApiKey}`);
      const data = await res.json();
      return data.results[0]?.components?.country || "Unknown";
    }

    function createEntryHTML(scrapboxUrl, pageTitle, textBlock) {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML = `
        <h3>Scrapboxページ: <a href="${scrapboxUrl}" target="_blank">${pageTitle}</a></h3>
        <textarea readonly>${textBlock}</textarea>
        <br>
        <button class="copy-button" onclick="copyToClipboard(this)">📋 コピー</button>
      `;
      return div;
    }

    function copyToClipboard(button) {
      const textarea = button.previousElementSibling;
      textarea.select();
      document.execCommand("copy");
      button.textContent = "✅ コピー完了";
      setTimeout(() => button.textContent = "📋 コピー", 1500);
    }

    async function processPhotos() {
      const input = document.getElementById('photoInput');
      const results = document.getElementById('results');
      results.innerHTML = "";
      const files = [...input.files];

      const grouped = {};

      for (let file of files) {
        const { date, latitude, longitude } = await getExifData(file);
        const imgUrl = await uploadToImgur(file);
        const mapUrl = (latitude && longitude) ? `https://maps.google.com/?q=${latitude},${longitude}` : '位置情報なし';
        const country = await getCountryFromCoords(latitude, longitude);

        const dateOnly = date.split(' ')[0];
        const countrySafe = country.replace(/\s+/g, '');
        const pageKey = `${countrySafe}/${dateOnly}`;

        const block = [
          `撮影日時: ${date}`,
          `Googleマップ: ${mapUrl}`,
          `[${imgUrl}]`,
          `[cc${countrySafe}]`
        ].join("\n");

        if (!grouped[pageKey]) grouped[pageKey] = { country, date: dateOnly, blocks: [] };
        grouped[pageKey].blocks.push(block);
      }

      for (let key of Object.keys(grouped).sort()) {
        const group = grouped[key];
        const scrapboxPageTitle = `${group.country}/${group.date}`;
        const encoded = encodeURIComponent(scrapboxPageTitle);
        const scrapboxUrl = `https://scrapbox.io/${scrapboxProject}/${encoded}`;
        const textBlock = group.blocks.join("\n\n");
        const entryHTML = createEntryHTML(scrapboxUrl, scrapboxPageTitle, textBlock);
        results.appendChild(entryHTML);
      }
    }
  </script>
</body>
</html>
