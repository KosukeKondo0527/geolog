<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>log() - A Developer's Travel Map</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f9f9f9;
      text-align: center;
    }
    h1 {
      margin-top: 30px;
    }
    svg {
      width: 100%;
      height: 600px;
      touch-action: none; /* タッチアクションをブラウザのデフォルト動作から切り離す */
    }
    footer {
      margin: 40px 0;
      font-size: 0.9rem;
      color: #777;
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
  <h1>log() — A Developer's Trace Around the World</h1>
  <svg id="map"></svg>
  <footer>&copy; 2025 Kosuke Kondo</footer>

  <script>
    const visitedCountries = ["JPN", "TUR", "ALB", "GEO"];  // 2文字から3文字コードに変更
    const baseUrl = "https://example.com/";

    const width = 960;
    const height = 600;

    const svg = d3.select("#map")
      .attr("viewBox", `0 0 ${width} ${height}`);

    // グループ要素を追加してズーム操作の対象とする
    const g = svg.append("g");

    // ズーム動作を定義
    const zoom = d3.zoom()
      .scaleExtent([1, 8])  // 拡大範囲: 1倍〜8倍
      .translateExtent([[-width * 0.2, -height * 0.2], [width * 1.2, height * 1.2]]) // より厳しい制限に
      .on("zoom", (event) => {
        // 移動範囲に追加の制限をかける
        const transform = event.transform;
        const scale = transform.k;
        
        // スケールに応じて制限を動的に調整
        const maxX = 0;
        const maxY = 0;
        
        // x, y座標を制限範囲内に収める
        transform.x = Math.min(Math.max(transform.x, -maxX), maxX);
        transform.y = Math.min(Math.max(transform.y, -maxY), maxY);
        
        g.attr("transform", transform);
      })
      .touchable(true);  // タッチイベントを明示的に有効化

    // SVGにズーム動作を適用
    svg.call(zoom)
      .on("touchstart touchmove", function(event) {
        // ピンチイベント中はページスクロールをブロック
        if (event.touches && event.touches.length >= 2) {
          event.preventDefault();
        }
      });

    const projection = d3.geoMercator()
      .center([0, 35])
      .rotate([-150, 0]) // 150°E を中心に回転させると日本の右側にアメリカが表示される
      .scale(150)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(worldData => {
      // 南極大陸を除外してから国データを作成
      const countries = topojson.feature(worldData, worldData.objects.countries).features
        .filter(d => d.properties.name !== "Antarctica"); // 南極大陸を除外
      
      // サンプルの国のプロパティを詳細に出力
      const japan = countries.find(c => c.properties.name === "Japan");
      console.log("日本の完全なプロパティ一覧:", japan);
      console.log("日本のID:", japan.id);
      console.log("日本のプロパティ:", japan.properties);
      
      // 国コード情報を追加でフェッチ
      d3.json("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/slim-3/slim-3.json").then(countryData => {
        
        // 不要なマッピングを削除
        // nameToISO3と nameToNumericは使用されていないため削除
        
        // 3文字コードから数値IDへのマッピング自動生成
        const iso3ToId = {};
        countryData.forEach(country => {
          iso3ToId[country["alpha-3"]] = parseInt(country["country-code"], 10);
        });
        
        // デバッグログを削減（本番では不要）
        // console.log("3文字コード→数値ID変換マップ:", iso3ToId);
        console.log("JPN→数値ID:", iso3ToId["JPN"]); // 基本動作確認用
        
        // 数値IDから3文字コードへの逆引きマップを作成
        const idToISO3 = {};
        for (const [code, id] of Object.entries(iso3ToId)) {
          idToISO3[id] = code;
        }

        // SVG選択を g に変更（ズーム対象のグループ要素）
        g.selectAll("path")
          .data(countries)
          .join("path")
          .attr("d", path)
          .attr("fill", d => {
            // 文字列型のIDを数値に変換して比較
            const numId = Number(d.id);
            
            // IDによる直接マッピング（数値型で統一）
            const isVisited = visitedCountries.some(code => iso3ToId[code] === numId);
            
            // 日本のデータをデバッグ
            if (d.properties.name === "Japan") {
              console.log("日本の比較(数値型):", 
                numId, 
                typeof numId,
                iso3ToId["JPN"], 
                typeof iso3ToId["JPN"],
                numId === iso3ToId["JPN"]
              );
            }
            
            
            if (isVisited) {
              return "#29b6f6"; // 訪問済みの国
            } else {
              return "#ccc"; // その他の国
            }
          })
          .attr("stroke", "#fff")
          .attr("stroke-width", 0.5)
          .on("click", (event, d) => {
            // 数値型に変換してからマップ検索
            const numId = Number(d.id);
            const iso3Code = idToISO3[numId];
            if (iso3Code && visitedCountries.includes(iso3Code)) {
              window.open(baseUrl + iso3Code, "_blank");
            }
          })
          .append("title")
          .text(d => {
            // 数値型に変換してからマップ検索
            const numId = Number(d.id);
            const iso3Code = idToISO3[numId];
            return d.properties.name + (iso3Code && visitedCountries.includes(iso3Code) ? " (Visited)" : "");
          });
      });
    });
  </script>
</body>
</html>
